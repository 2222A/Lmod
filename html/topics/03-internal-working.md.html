<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<head>
    <title>Lmod Documentation</title>
    <link rel="stylesheet" href="../ldoc.css" type="text/css" />
</head>
<body>

<div id="container">

<div id="product">
	<div id="product_logo"></div>
	<div id="product_name"><big><b></b></big></div>
	<div id="product_description"></div>
</div> <!-- id="product" -->


<div id="main">


<!-- Menu -->

<div id="navigation">
<br/>
<h1>Lmod</h1>

<ul>
  <li><a href="../index.html">Index</a></li>
</ul>

<h2>Contents</h2>
<ul>
<li><a href="#Level_0_">Level 0: </a></li>
<li><a href="#Level_1_">Level 1: </a></li>
<li><a href="#Level_2">Level 2 </a></li>
<li><a href="#Level_3">Level 3 </a></li>
<li><a href="#Level_4">Level 4 </a></li>
<li><a href="#Level_5">Level 5 </a></li>
<li><a href="#Level_6">Level 6 </a></li>
<li><a href="#Other_possible_topics">Other possible topics </a></li>
</ul>


<h2>Topics</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../topics/01-introduction.md.html">01-introduction</a></li>
  <li><a href="../topics/02-sys-admin-guide.md.html">02-sys-admin-guide</a></li>
  <li><strong>03-internal-working</strong></li>
</ul>
<h2>Modules</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../modules/SitePackage.html">SitePackage</a></li>
  <li><a href="../modules/StandardPackage.html">StandardPackage</a></li>
  <li><a href="../modules/TermWidth.html">TermWidth</a></li>
  <li><a href="../modules/capture.html">capture</a></li>
  <li><a href="../modules/cmdfuncs.html">cmdfuncs</a></li>
  <li><a href="../modules/colorize.html">colorize</a></li>
  <li><a href="../modules/declare.html">declare</a></li>
  <li><a href="../modules/fileOps.html">fileOps</a></li>
  <li><a href="../modules/inherits.html">inherits</a></li>
  <li><a href="../modules/json.html">json</a></li>
  <li><a href="../modules/loadModuleFile.html">loadModuleFile</a></li>
  <li><a href="../modules/modfuncs.html">modfuncs</a></li>
  <li><a href="../modules/myGlobals.html">myGlobals</a></li>
  <li><a href="../modules/pager.html">pager</a></li>
  <li><a href="../modules/pairsByKeys.html">pairsByKeys</a></li>
  <li><a href="../modules/parseVersion.html">parseVersion</a></li>
  <li><a href="../modules/sandbox.html">sandbox</a></li>
  <li><a href="../modules/serializeTbl.html">serializeTbl</a></li>
  <li><a href="../modules/utils.html">utils</a></li>
</ul>
<h2>Scripts</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../scripts/addto.html">addto</a></li>
  <li><a href="../scripts/clearMT_cmd.html">clearMT_cmd</a></li>
  <li><a href="../scripts/computeHashSum.html">computeHashSum</a></li>
  <li><a href="../scripts/getmt.html">getmt</a></li>
  <li><a href="../scripts/lmod.html">lmod</a></li>
  <li><a href="../scripts/ml.html">ml</a></li>
  <li><a href="../scripts/processMT.html">processMT</a></li>
  <li><a href="../scripts/processModuleUsage.html">processModuleUsage</a></li>
  <li><a href="../scripts/reportUsers.html">reportUsers</a></li>
  <li><a href="../scripts/sh_to_modulefile.html">sh_to_modulefile</a></li>
  <li><a href="../scripts/spider.html">spider</a></li>
  <li><a href="../scripts/spiderCacheSupport.html">spiderCacheSupport</a></li>
</ul>
<h2>Classes</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../classes/Banner.html">Banner</a></li>
  <li><a href="../classes/BeautifulTbl.html">BeautifulTbl</a></li>
  <li><a href="../classes/CTimer.html">CTimer</a></li>
  <li><a href="../classes/Cache.html">Cache</a></li>
  <li><a href="../classes/ColumnTable.html">ColumnTable</a></li>
  <li><a href="../classes/Configuration.html">Configuration</a></li>
  <li><a href="../classes/Dbg.html">Dbg</a></li>
  <li><a href="../classes/Exec.html">Exec</a></li>
  <li><a href="../classes/Hook.html">Hook</a></li>
  <li><a href="../classes/MC_Access.html">MC_Access</a></li>
  <li><a href="../classes/MC_ComputeHash.html">MC_ComputeHash</a></li>
  <li><a href="../classes/MC_Load.html">MC_Load</a></li>
  <li><a href="../classes/MC_MgrLoad.html">MC_MgrLoad</a></li>
  <li><a href="../classes/MC_Refresh.html">MC_Refresh</a></li>
  <li><a href="../classes/MC_Show.html">MC_Show</a></li>
  <li><a href="../classes/MC_Spider.html">MC_Spider</a></li>
  <li><a href="../classes/MC_Unload.html">MC_Unload</a></li>
  <li><a href="../classes/MF_Base.html">MF_Base</a></li>
  <li><a href="../classes/MF_Lua.html">MF_Lua</a></li>
  <li><a href="../classes/MF_TCL.html">MF_TCL</a></li>
  <li><a href="../classes/MN_Between.html">MN_Between</a></li>
  <li><a href="../classes/MN_Latest.html">MN_Latest</a></li>
  <li><a href="../classes/MN_Match.html">MN_Match</a></li>
  <li><a href="../classes/MName.html">MName</a></li>
  <li><a href="../classes/MT.html">MT</a></li>
  <li><a href="../classes/Master.html">Master</a></li>
  <li><a href="../classes/MasterControl.html">MasterControl</a></li>
  <li><a href="../classes/ModuleStack.html">ModuleStack</a></li>
  <li><a href="../classes/Optiks.html">Optiks</a></li>
  <li><a href="../classes/Optiks_Option.html">Optiks_Option</a></li>
  <li><a href="../classes/Options.html">Options</a></li>
  <li><a href="../classes/Pkg.html">Pkg</a></li>
  <li><a href="../classes/PkgBase.html">PkgBase</a></li>
  <li><a href="../classes/PkgTACC.html">PkgTACC</a></li>
  <li><a href="../classes/ProgressBar.html">ProgressBar</a></li>
  <li><a href="../classes/Spider.html">Spider</a></li>
  <li><a href="../classes/Timer.html">Timer</a></li>
  <li><a href="../classes/Var.html">Var</a></li>
  <li><a href="../classes/string.html">string</a></li>
</ul>

</div>

<div id="content">

    It may be helpful to follow the actions and routines that handle a module load.
This will be explained from the outer most level and will work inward.</p>

<p><a name="Level_0_"></a></p>
<h2>Level 0:</h2>

<p>To start with a bash user enters a "module load foo".  Let assume that the foo module
contains:</p>


<pre>
setenv (<span class="string">"FOO_VERSION"</span>,<span class="string">"1.0"</span>)
</pre>

<p>and the module command is defined as</p>


<pre>
<span class="global">module</span> () { eval $(/path/to/lmod bash <span class="string">"$@"</span>); }
</pre>

<p>The user command translates to</p>


<pre>
eval $( /path/to/lmod bash <span class="string">"load"</span> <span class="string">"foo"</span> )
</pre>

<p>And the command</p>


<pre>
/path/to/lmod/bash <span class="string">"load"</span> <span class="string">"foo"</span>
</pre>

<p>generates in its simplest form (hiding many details, explained later)</p>


<pre>
export FOO_VERSION=<span class="number">1.0</span>;
</pre>

<p>Which when evaluated sets FOO_VERSION to be "1.0" in the environment.  This is the basic
way that modules have work and has nothing to do with the internals of Lmod.  The main
point here is that the <em>lmod</em> command generates text which is a simple shell program which
the module shell function evaluates.  This is how the user's environment has changed
by <em>loading</em> the foo module.  </p>

<p><a name="Level_1_"></a></p>
<h2>Level 1:</h2>

<p>This level is to start with "/path/to/lmod bash 'load' 'foo'".</p>

<p>The lmod.lua script is the entry point to the Lmod complex.  The main steps are:</p>


<pre>
<span class="number">1.</span>  Parse Command line arguments
<span class="number">2.</span>  Find the action the user requested (e.g. <span class="global">load</span> the foo <span class="global">module</span>).
<span class="number">3.</span>  Invoke the action.
<span class="number">4.</span>  Output the changes.
</pre>

<p>Invoking the action builds two data structures <em>varTbl</em> and <em>MT</em>.  The <em>varTbl</em> is an
array of environment variable that the actions like loading a module will change such
as setting the *FOO_VERSION* variable to "1.0".</p>

<p>The other data structure built is <em>MT</em>.  This is the module table.  It is a lua table
and it contains a list of the module loaded, what is the filename for the module and
other information.  This table is the only way Lmod knows the state of the loaded modules
between invocations.</p>

<p>In step 4, Lmod reports the key value pairs in <em>varTbl</em> and the current value of <em>MT</em>
and generates simple program to be evaluated.  The new key value pairs are written as
bash, csh, python or perl script depending on what the first argument to the lmod
command is.</p>

<p>The module table is a lua table and looks like:</p>


<pre>
mt = {
  activeSize=<span class="number">1</span>,
  mT= {
    foo = {
       FN=<span class="string">"/path/to/foo/1.0.lua"</span>,
       ...
       }
   }
}
</pre>

<p>With the mix of quotes and commas it is difficult something like that directly, especially
in C-shell.  So Lmod serializes the table similarily to what is shown above but without
spaces and newlines removed.  Then that text is base64 encoded and stored in variables named
<em>ModuleTable001</em>, <em>ModuleTable002</em>, etc in blocks of 256 characters.  When Lmod starts, it
grabs those env. vars and puts them together to base64 decodes them to recover the current
state of the modules loaded.</p>

<p>To see the current module table you can do:</p>

<p>   $ module --mt</p>

<p><a name="Level_2"></a></p>
<h2>Level 2</h2>

<p>The command line actions are in src/cmdfuncs.lua.  Similarily, functions specified in module
files are in src/modfuncs.lua.  Explain why they are similar but not the same and maintained
separately.</p>

<p><a name="Level_3"></a></p>
<h2>Level 3</h2>

<p>When a module is loaded, the actions are treated in a positive way.  They generally say</p>


<pre>
setenv(<span class="string">"ABC"</span>,<span class="string">"DEF"</span>)
prepend_path(<span class="string">"PATH"</span>, <span class="string">"/path/to/add"</span>)
</pre>

<p>So loading this module would set <strong>ABC</strong> and prepend to the <strong>PATH</strong> variable.  When a module is
unloaded the <em>setenv</em> and <em>prepend_path</em> actions are reversed.  So when these modulefiles
are interpreted the action of the functions depends on which mode.  There are several modes
among then are <strong>load</strong>, <strong>unload</strong>, <strong>show</strong> and <strong>help</strong>.</p>

<p>When implementing a module file interpreter, one could have a single <em>setenv</em> function which
checked the mode to decide which action to implement (e.g. load, unload, print or no-op).
Instead Lmod uses an object oriented approach by using an factory to build an object which
performs the action in the desired direction.  The program maintains a global variable
<em>mcp</em> which first built in lmod.lua:</p>


<pre>
mcp = MasterControl.build(<span class="string">"load"</span>)
</pre>

<p>This builds an object which places actions in the positive.  When a user requests an unload,
then the program builds:</p>


<pre>
mcp = MasterControl.build(<span class="string">"unload"</span>)
</pre>

<p>This places the action in the negative direction.  An <em>setenv</em> or <em>prepend_path</em> will unset
a global variable or remove an entry from a path. </p>

<p>Another way that module files are interpreted is for show.  A <em>mcp</em> is built by:</p>


<pre>
mcp = MasterControl.build(<span class="string">"show"</span>)
</pre>

<p>This changes the modulefile actions to converted into print statements.  There are several
other modes that treat the actions of modulefiles differently.  The way that this is
implemented is that there is base class MasterControl (in src/MasterControl.lua) which
implements the functions a single positive and another in negative directions.  There is
a member load function and another member unload function.  When building the <strong>load</strong> version
of <em>mcp</em> the member setenv function points to the MasterControl.setenv function.  This can
be seen in src/MC_Load.lua</p>

<p>When building the <strong>unload</strong> version the setenv member function points to MasterControl.unsetenv
function.  It is the construction of the <strong>load</strong>, <strong>unload</strong>, <strong>show</strong>, etc versions of <em>mcp</em>
that changes the interpretation of the modulefile function.</p>

<p><a name="Level_4"></a></p>
<h2>Level 4</h2>

<p>Explain MName and the load and prereq modifiers work MN_*.</p>

<p><a name="Level_5"></a></p>
<h2>Level 5</h2>

<p>Explain how the spider cache works.</p>

<p><a name="Level_6"></a></p>
<h2>Level 6</h2>

<p>Explain how the sandbox works and why it is important.</p>

<p><a name="Other_possible_topics"></a></p>
<h2>Other possible topics</h2>

<p>*Master.lua
*How Lmod supports both sending messages stderr but will support sending module list, avail,
  etc to stdout.
*hooks?
*

</div> <!-- id="content" -->
</div> <!-- id="main" -->
<div id="about">
<i>generated by <a href="http://github.com/stevedonovan/LDoc">LDoc 1.4.2</a></i>
</div> <!-- id="about" -->
</div> <!-- id="container" -->
</body>
</html>
